openapi: 3.1.0
info:
  title: AuditSphere API (Main Branch)
  summary: SharePoint security monitoring and compliance API
  description: |
    tRPC-based API for AuditSphere SPFX integration.
    All endpoints require Azure AD authentication via Bearer token.

    Base URL: `/api/trpc`

    tRPC endpoints follow the pattern: `POST /api/trpc/{router}.{procedure}`
  version: 1.0.0
  contact:
    name: AuditSphere Team
  license:
    name: Proprietary
    identifier: LicenseRef-Proprietary

servers:
  - url: /api/trpc
    description: tRPC API endpoint

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Azure AD access token

  schemas:
    Pagination:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
          default: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        total:
          type: integer
        totalPages:
          type: integer

    Alert:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [ANOMALY, COMPLIANCE, SECURITY]
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        status:
          type: string
          enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
        title:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time

    Anomaly:
      type: object
      properties:
        id:
          type: string
        anomalyType:
          type: string
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        status:
          type: string
          enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
        confidence:
          type: number
        anomalyScore:
          type: number
        createdAt:
          type: string
          format: date-time

    AuditEvent:
      type: object
      properties:
        id:
          type: string
        eventId:
          type: string
        operation:
          type: string
        userId:
          type: string
        siteUrl:
          type: string
        sourceFileName:
          type: string
        creationTime:
          type: string
          format: date-time
        clientIp:
          type: string

    ComplianceRun:
      type: object
      properties:
        id:
          type: string
        standardId:
          type: string
        status:
          type: string
          enum: [running, completed, failed]
        totalChecks:
          type: integer
        passedChecks:
          type: integer
        failedChecks:
          type: integer
        startedAt:
          type: string
          format: date-time

    Report:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [access_audit, compliance, anomaly, sharing, external_access]
        format:
          type: string
          enum: [pdf, xlsx, csv]
        status:
          type: string
          enum: [pending, generating, completed, error]
        createdAt:
          type: string
          format: date-time

    SharePointSite:
      type: object
      properties:
        id:
          type: string
        siteId:
          type: string
        siteUrl:
          type: string
        title:
          type: string
        isExternal:
          type: boolean

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        name:
          type: string
        role:
          type: string
        hasMicrosoftConnection:
          type: boolean

    # ==================== Access Review Schemas ====================
    AccessReviewCampaign:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        scope:
          type: object
          properties:
            siteUrls:
              type: array
              items:
                type: string
            includeDrives:
              type: boolean
            includeSubfolders:
              type: boolean
            maxDepth:
              type: integer
        status:
          type: string
          enum: [draft, scheduled, collecting, in_review, completed, cancelled]
        dueDate:
          type: string
          format: date-time
          nullable: true
        totalItems:
          type: integer
        reviewedItems:
          type: integer
        retainedItems:
          type: integer
        removedItems:
          type: integer
        createdAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true

    AccessReviewItem:
      type: object
      properties:
        id:
          type: string
        campaignId:
          type: string
        resourceType:
          type: string
          enum: [site, drive, folder, file]
        resourceId:
          type: string
        resourceName:
          type: string
        resourcePath:
          type: string
        siteUrl:
          type: string
          nullable: true
        permissionId:
          type: string
        permissionType:
          type: string
          enum: [user, group, shareLink, application]
        grantedTo:
          type: string
          nullable: true
        grantedToId:
          type: string
          nullable: true
        grantedToType:
          type: string
          enum: [user, group, application]
          nullable: true
        accessLevel:
          type: string
          enum: [read, write, owner]
        permissionOrigin:
          type: string
          enum: [direct, inherited]
          nullable: true
        sharingLinkType:
          type: string
          enum: [anonymous, organization, users]
          nullable: true
        expiresAt:
          type: string
          format: date-time
          nullable: true
        decision:
          $ref: '#/components/schemas/AccessReviewDecision'

    AccessReviewDecision:
      type: object
      properties:
        id:
          type: string
        itemId:
          type: string
        decision:
          type: string
          enum: [retain, remove]
        justification:
          type: string
          nullable: true
        decidedAt:
          type: string
          format: date-time
          nullable: true
        reviewerEmail:
          type: string
          nullable: true
        executionStatus:
          type: string
          enum: [pending, in_progress, completed, failed]
        executedAt:
          type: string
          format: date-time
          nullable: true
        executionError:
          type: string
          nullable: true

    ScheduledReview:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        enabled:
          type: boolean
        scope:
          type: object
        frequency:
          type: string
          enum: [weekly, monthly, quarterly, yearly]
        dayOfWeek:
          type: integer
          nullable: true
        dayOfMonth:
          type: integer
          nullable: true
        time:
          type: string
        reviewPeriodDays:
          type: integer
        autoExecute:
          type: boolean
        nextRunAt:
          type: string
          format: date-time
          nullable: true
        lastRunAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    DesignatedOwner:
      type: object
      properties:
        id:
          type: string
        siteUrl:
          type: string
        ownerEmail:
          type: string
        ownerName:
          type: string
          nullable: true
        ownerType:
          type: string
          enum: [primary, backup, delegate]
        notes:
          type: string
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    AccessReviewNotification:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        campaignId:
          type: string
          nullable: true
        type:
          type: string
          enum: [campaign_started, campaign_due_soon, campaign_overdue, review_assigned, execution_complete, schedule_triggered]
        title:
          type: string
        message:
          type: string
        readAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    # ==================== Graph API Schemas ====================
    GraphDrive:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        webUrl:
          type: string
        driveType:
          type: string
          enum: [personal, business, documentLibrary]

    GraphDriveItem:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        webUrl:
          type: string
        isFolder:
          type: boolean
        childCount:
          type: integer
        mimeType:
          type: string
          nullable: true

    GraphSite:
      type: object
      properties:
        id:
          type: string
        displayName:
          type: string
        webUrl:
          type: string

paths:
  # ==================== Alerts ====================
  /alerts.list:
    post:
      tags: [Alerts]
      summary: List alerts with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                type:
                  type: string
                  enum: [ANOMALY, COMPLIANCE, SECURITY]
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
                status:
                  type: string
                  enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Alert'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /alerts.getById:
    post:
      tags: [Alerts]
      summary: Get alert by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Alert details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'

  /alerts.updateStatus:
    post:
      tags: [Alerts]
      summary: Update alert status
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id, status]
              properties:
                id:
                  type: string
                status:
                  type: string
                  enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
      responses:
        '200':
          description: Updated alert
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'

  /alerts.stats:
    post:
      tags: [Alerts]
      summary: Get alert statistics
      responses:
        '200':
          description: Alert statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  recentAlerts:
                    type: integer
                  unreadCount:
                    type: integer
                  bySeverity:
                    type: object
                  byStatus:
                    type: object
                  byType:
                    type: object

  /alerts.markAllRead:
    post:
      tags: [Alerts]
      summary: Mark all alerts as read
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== Anomalies ====================
  /anomalies.list:
    post:
      tags: [Anomalies]
      summary: List anomalies with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
                status:
                  type: string
                  enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
                anomalyType:
                  type: string
                userId:
                  type: string
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of anomalies
          content:
            application/json:
              schema:
                type: object
                properties:
                  anomalies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Anomaly'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /anomalies.getById:
    post:
      tags: [Anomalies]
      summary: Get anomaly by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Anomaly details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Anomaly'

  /anomalies.updateStatus:
    post:
      tags: [Anomalies]
      summary: Update anomaly status
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id, status]
              properties:
                id:
                  type: string
                status:
                  type: string
                  enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
                resolution:
                  type: string
                  maxLength: 1000
      responses:
        '200':
          description: Updated anomaly
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Anomaly'

  /anomalies.stats:
    post:
      tags: [Anomalies]
      summary: Get anomaly statistics
      responses:
        '200':
          description: Anomaly statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  recentAnomalies:
                    type: integer
                  unresolvedCount:
                    type: integer
                  bySeverity:
                    type: object
                  byStatus:
                    type: object
                  byType:
                    type: array

  # ==================== Audit Events ====================
  /auditEvents.list:
    post:
      tags: [Audit Events]
      summary: List audit events with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                operation:
                  type: string
                userId:
                  type: string
                siteUrl:
                  type: string
                userType:
                  type: integer
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  total:
                    type: integer
                  anomalyCount:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /auditEvents.getById:
    post:
      tags: [Audit Events]
      summary: Get audit event by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Audit event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEvent'

  /auditEvents.stats:
    post:
      tags: [Audit Events]
      summary: Get audit event statistics
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 90
                  default: 7
      responses:
        '200':
          description: Audit event statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                  operations:
                    type: array
                  userTypes:
                    type: array
                  dailyTrend:
                    type: array
                  users:
                    type: array

  /auditEvents.getUsers:
    post:
      tags: [Audit Events]
      summary: Get unique users list
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 90
                  default: 30
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    userId:
                      type: string
                    eventCount:
                      type: integer

  # ==================== Compliance ====================
  /compliance.run:
    post:
      tags: [Compliance]
      summary: Run compliance checks
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                standardId:
                  type: string
                  enum: [CIS-MS365, CUSTOM, ALL]
                siteUrls:
                  type: array
                  items:
                    type: string
                    format: uri
      responses:
        '200':
          description: Compliance run started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  runId:
                    type: string
                  message:
                    type: string

  /compliance.summary:
    post:
      tags: [Compliance]
      summary: Get compliance summary
      responses:
        '200':
          description: Compliance summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  passed:
                    type: integer
                  failed:
                    type: integer
                  passRate:
                    type: integer
                  lastRunAt:
                    type: string
                    format: date-time

  /compliance.runs:
    post:
      tags: [Compliance]
      summary: List compliance runs
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 10
      responses:
        '200':
          description: List of compliance runs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ComplianceRun'

  /compliance.runById:
    post:
      tags: [Compliance]
      summary: Get compliance run details
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Compliance run details
          content:
            application/json:
              schema:
                type: object
                properties:
                  run:
                    $ref: '#/components/schemas/ComplianceRun'
                  checks:
                    type: array

  /compliance.checkDefinitions:
    post:
      tags: [Compliance]
      summary: Get compliance check definitions
      responses:
        '200':
          description: Check definitions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    code:
                      type: string
                    name:
                      type: string
                    description:
                      type: string
                    category:
                      type: string
                    severity:
                      type: string
                    standardId:
                      type: string

  /compliance.latestChecks:
    post:
      tags: [Compliance]
      summary: Get latest compliance check results
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 50
                status:
                  type: string
                  enum: [PASS, FAIL, WARNING, ERROR, SKIPPED]
                category:
                  type: string
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
      responses:
        '200':
          description: Latest check results
          content:
            application/json:
              schema:
                type: object
                properties:
                  checks:
                    type: array
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /compliance.clear:
    post:
      tags: [Compliance]
      summary: Clear compliance results
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== Dashboard ====================
  /dashboard.overview:
    post:
      tags: [Dashboard]
      summary: Get dashboard overview data
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 30
                  default: 7
      responses:
        '200':
          description: Dashboard overview
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: object
                  anomalies:
                    type: object
                  alerts:
                    type: object
                  compliance:
                    type: object
                  trends:
                    type: object
                  period:
                    type: object

  /dashboard.quickStats:
    post:
      tags: [Dashboard]
      summary: Get quick stats for header/nav
      responses:
        '200':
          description: Quick stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  unresolvedAnomalies:
                    type: integer
                  unreadAlerts:
                    type: integer

  /dashboard.activityFeed:
    post:
      tags: [Dashboard]
      summary: Get activity feed
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 20
      responses:
        '200':
          description: Activity feed
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [event, anomaly]
                    id:
                      type: string
                    timestamp:
                      type: string
                      format: date-time
                    title:
                      type: string
                    subtitle:
                      type: string
                    details:
                      type: string

  # ==================== Microsoft ====================
  /microsoft.checkConnection:
    post:
      tags: [Microsoft]
      summary: Check Microsoft connection using app credentials (public)
      security: []
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean
                  message:
                    type: string
                  tenantId:
                    type: string
                    nullable: true
                  tenantName:
                    type: string
                    nullable: true

  /microsoft.status:
    post:
      tags: [Microsoft]
      summary: Get Microsoft connection status
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean
                  connections:
                    type: array

  /microsoft.sites:
    post:
      tags: [Microsoft]
      summary: Get SharePoint sites
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    graphId:
                      type: string
                    displayName:
                      type: string
                    webUrl:
                      type: string

  /microsoft.disconnect:
    post:
      tags: [Microsoft]
      summary: Disconnect Microsoft account
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [connectionId]
              properties:
                connectionId:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /microsoft.health:
    post:
      tags: [Microsoft]
      summary: Get connection health
      responses:
        '200':
          description: Connection health
          content:
            application/json:
              schema:
                type: object
                properties:
                  healthy:
                    type: boolean
                  message:
                    type: string
                  lastSync:
                    type: string
                    format: date-time
                  tenantName:
                    type: string

  /microsoft.drives:
    post:
      tags: [Microsoft]
      summary: Get drives (document libraries) for a site
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [siteId]
              properties:
                siteId:
                  type: string
      responses:
        '200':
          description: List of drives
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GraphDrive'

  /microsoft.folderContents:
    post:
      tags: [Microsoft]
      summary: Get folder contents (children)
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [driveId]
              properties:
                driveId:
                  type: string
                folderId:
                  type: string
                  default: root
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GraphDriveItem'

  /microsoft.site:
    post:
      tags: [Microsoft]
      summary: Get site details by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [siteId]
              properties:
                siteId:
                  type: string
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphSite'

  # ==================== Reports ====================
  /reports.list:
    post:
      tags: [Reports]
      summary: List reports
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                type:
                  type: string
                  enum: [access_audit, compliance, anomaly, sharing, external_access]
                status:
                  type: string
                  enum: [PENDING, GENERATING, COMPLETED, FAILED]
      responses:
        '200':
          description: List of reports
          content:
            application/json:
              schema:
                type: object
                properties:
                  reports:
                    type: array
                    items:
                      $ref: '#/components/schemas/Report'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /reports.getById:
    post:
      tags: [Reports]
      summary: Get report by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Report details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /reports.generate:
    post:
      tags: [Reports]
      summary: Generate a new report
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, type]
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                type:
                  type: string
                  enum: [access_audit, compliance, anomaly, sharing, external_access]
                format:
                  type: string
                  enum: [pdf, xlsx, csv]
                  default: csv
                parameters:
                  type: object
      responses:
        '200':
          description: Generated report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /reports.delete:
    post:
      tags: [Reports]
      summary: Delete a report
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /reports.types:
    post:
      tags: [Reports]
      summary: Get report types
      responses:
        '200':
          description: Report types
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    description:
                      type: string

  # ==================== Sites ====================
  /sites.list:
    post:
      tags: [Sites]
      summary: List SharePoint sites
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                search:
                  type: string
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: object
                properties:
                  sites:
                    type: array
                    items:
                      $ref: '#/components/schemas/SharePointSite'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /sites.getById:
    post:
      tags: [Sites]
      summary: Get site by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SharePointSite'

  /sites.stats:
    post:
      tags: [Sites]
      summary: Get site statistics
      responses:
        '200':
          description: Site statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  externalCount:
                    type: integer
                  recentlyActive:
                    type: integer

  # ==================== Settings ====================
  /settings.getCredentials:
    post:
      tags: [Settings]
      summary: Get credentials status (masked)
      responses:
        '200':
          description: Credentials status
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasCustomCredentials:
                    type: boolean
                  useCustomCredentials:
                    type: boolean
                  envConfigured:
                    type: boolean
                  credentials:
                    type: object

  /settings.saveCredentials:
    post:
      tags: [Settings]
      summary: Save or update credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [tenantId, clientId, clientSecret]
              properties:
                tenantId:
                  type: string
                clientId:
                  type: string
                clientSecret:
                  type: string
                useCustomCredentials:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /settings.deleteCredentials:
    post:
      tags: [Settings]
      summary: Delete custom credentials
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /settings.toggleCustomCredentials:
    post:
      tags: [Settings]
      summary: Toggle use of custom credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [useCustomCredentials]
              properties:
                useCustomCredentials:
                  type: boolean
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  useCustomCredentials:
                    type: boolean

  # ==================== User ====================
  /user.me:
    post:
      tags: [User]
      summary: Get current user info
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  # ==================== Access Review - Campaigns ====================
  /accessReview.listCampaigns:
    post:
      tags: [Access Review]
      summary: List access review campaigns
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                status:
                  type: string
                  enum: [draft, scheduled, collecting, in_review, completed, cancelled]
      responses:
        '200':
          description: List of campaigns
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaigns:
                    type: array
                    items:
                      $ref: '#/components/schemas/AccessReviewCampaign'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /accessReview.getCampaign:
    post:
      tags: [Access Review]
      summary: Get campaign by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Campaign details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewCampaign'

  /accessReview.createCampaign:
    post:
      tags: [Access Review]
      summary: Create a new campaign
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, scope]
              properties:
                name:
                  type: string
                  minLength: 1
                description:
                  type: string
                scope:
                  type: object
                  required: [siteUrls]
                  properties:
                    siteUrls:
                      type: array
                      items:
                        type: string
                    includeDrives:
                      type: boolean
                      default: true
                    includeSubfolders:
                      type: boolean
                      default: true
                    maxDepth:
                      type: integer
                      default: 3
                dueDate:
                  type: string
                  format: date-time
                recurrence:
                  type: string
                  description: Recurrence pattern (e.g., weekly, monthly)
      responses:
        '200':
          description: Created campaign
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewCampaign'

  /accessReview.updateCampaign:
    post:
      tags: [Access Review]
      summary: Update a campaign
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                name:
                  type: string
                description:
                  type: string
                scope:
                  type: object
                dueDate:
                  type: string
                  format: date-time
                  nullable: true
                recurrence:
                  type: string
                  nullable: true
                  description: Recurrence pattern (e.g., weekly, monthly)
      responses:
        '200':
          description: Updated campaign
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewCampaign'

  /accessReview.deleteCampaign:
    post:
      tags: [Access Review]
      summary: Delete a campaign
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /accessReview.startCampaign:
    post:
      tags: [Access Review]
      summary: Start campaign - collect permissions from SharePoint
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Campaign started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  itemsCollected:
                    type: integer

  /accessReview.completeCampaign:
    post:
      tags: [Access Review]
      summary: Mark campaign as completed
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /accessReview.executeCampaign:
    post:
      tags: [Access Review]
      summary: Execute removal decisions in SharePoint
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Execution results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: object
                    properties:
                      success:
                        type: integer
                      failed:
                        type: integer

  /accessReview.getCampaignStats:
    post:
      tags: [Access Review]
      summary: Get campaign statistics
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Campaign statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign:
                    type: object
                  summary:
                    type: object
                    properties:
                      totalItems:
                        type: integer
                      itemsWithDecisions:
                        type: integer
                      itemsNeedingReview:
                        type: integer
                      reviewProgress:
                        type: integer
                      retainDecisions:
                        type: integer
                      removeDecisions:
                        type: integer
                  breakdown:
                    type: object

  # ==================== Access Review - Items ====================
  /accessReview.listItems:
    post:
      tags: [Access Review]
      summary: List review items for a campaign
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [campaignId]
              properties:
                campaignId:
                  type: string
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 100
                resourceType:
                  type: string
                  enum: [site, drive, folder, file, all]
                grantedToType:
                  type: string
                  enum: [user, group, application, all]
                decision:
                  type: string
                  enum: [retain, remove, pending]
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/AccessReviewItem'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /accessReview.getItem:
    post:
      tags: [Access Review]
      summary: Get item details
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Item details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewItem'

  # ==================== Access Review - Decisions ====================
  /accessReview.submitDecision:
    post:
      tags: [Access Review]
      summary: Submit decision for a review item
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [itemId, decision]
              properties:
                itemId:
                  type: string
                decision:
                  type: string
                  enum: [retain, remove]
                justification:
                  type: string
      responses:
        '200':
          description: Submitted decision
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewDecision'

  /accessReview.bulkDecisions:
    post:
      tags: [Access Review]
      summary: Submit multiple decisions at once
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [decisions]
              properties:
                decisions:
                  type: array
                  items:
                    type: object
                    required: [itemId, decision]
                    properties:
                      itemId:
                        type: string
                      decision:
                        type: string
                        enum: [retain, remove]
      responses:
        '200':
          description: Bulk decision results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: object
                    properties:
                      success:
                        type: integer
                      failed:
                        type: integer

  /accessReview.bulkRetainAll:
    post:
      tags: [Access Review]
      summary: Retain all pending items in a campaign
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [campaignId]
              properties:
                campaignId:
                  type: string
      responses:
        '200':
          description: Bulk retain results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: integer
                  total:
                    type: integer

  # ==================== Access Review - Schedules ====================
  /accessReview.listSchedules:
    post:
      tags: [Access Review]
      summary: List scheduled reviews
      responses:
        '200':
          description: List of schedules
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedules:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScheduledReview'

  /accessReview.createSchedule:
    post:
      tags: [Access Review]
      summary: Create a scheduled review
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, scope, frequency]
              properties:
                name:
                  type: string
                  minLength: 1
                description:
                  type: string
                scope:
                  type: object
                  required: [siteUrls]
                  properties:
                    siteUrls:
                      type: array
                      items:
                        type: string
                    includeDrives:
                      type: boolean
                    includeSubfolders:
                      type: boolean
                    maxDepth:
                      type: integer
                frequency:
                  type: string
                  enum: [weekly, monthly, quarterly, yearly]
                dayOfWeek:
                  type: integer
                  minimum: 0
                  maximum: 6
                dayOfMonth:
                  type: integer
                  minimum: 1
                  maximum: 31
                time:
                  type: string
                  default: "09:00"
                reviewPeriodDays:
                  type: integer
                  default: 14
                autoExecute:
                  type: boolean
                  default: false
                sendReportToOwners:
                  type: boolean
                  default: true
                  description: Send report emails to designated site owners
                adminEmails:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Created schedule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledReview'

  /accessReview.updateSchedule:
    post:
      tags: [Access Review]
      summary: Update a scheduled review
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                name:
                  type: string
                description:
                  type: string
                enabled:
                  type: boolean
                scope:
                  type: object
                  properties:
                    siteUrls:
                      type: array
                      items:
                        type: string
                    includeDrives:
                      type: boolean
                    includeSubfolders:
                      type: boolean
                    maxDepth:
                      type: integer
                frequency:
                  type: string
                  enum: [weekly, monthly, quarterly, yearly]
                dayOfWeek:
                  type: integer
                  minimum: 0
                  maximum: 6
                dayOfMonth:
                  type: integer
                  minimum: 1
                  maximum: 31
                time:
                  type: string
                reviewPeriodDays:
                  type: integer
                autoExecute:
                  type: boolean
                sendReportToOwners:
                  type: boolean
                adminEmails:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Updated schedule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduledReview'

  /accessReview.deleteSchedule:
    post:
      tags: [Access Review]
      summary: Delete a scheduled review
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /accessReview.runSchedule:
    post:
      tags: [Access Review]
      summary: Manually run a scheduled review now
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Created campaign from schedule
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign:
                    $ref: '#/components/schemas/AccessReviewCampaign'

  # ==================== Access Review - Designated Owners ====================
  /accessReview.listDesignatedOwners:
    post:
      tags: [Access Review]
      summary: List designated owners
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                siteUrl:
                  type: string
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 50
      responses:
        '200':
          description: List of owners
          content:
            application/json:
              schema:
                type: object
                properties:
                  owners:
                    type: array
                    items:
                      $ref: '#/components/schemas/DesignatedOwner'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /accessReview.getDesignatedOwner:
    post:
      tags: [Access Review]
      summary: Get designated owner by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Designated owner details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DesignatedOwner'

  /accessReview.createDesignatedOwner:
    post:
      tags: [Access Review]
      summary: Create a designated owner
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [siteUrl, ownerEmail]
              properties:
                siteUrl:
                  type: string
                ownerEmail:
                  type: string
                  format: email
                ownerName:
                  type: string
                ownerType:
                  type: string
                  enum: [primary, backup, delegate]
                  default: primary
                notes:
                  type: string
      responses:
        '200':
          description: Created owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DesignatedOwner'

  /accessReview.updateDesignatedOwner:
    post:
      tags: [Access Review]
      summary: Update a designated owner
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                ownerEmail:
                  type: string
                  format: email
                ownerName:
                  type: string
                ownerType:
                  type: string
                  enum: [primary, backup, delegate]
                notes:
                  type: string
                isActive:
                  type: boolean
      responses:
        '200':
          description: Updated owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DesignatedOwner'

  /accessReview.deleteDesignatedOwner:
    post:
      tags: [Access Review]
      summary: Delete a designated owner
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /accessReview.getOwnersForSite:
    post:
      tags: [Access Review]
      summary: Get active owners for a specific site
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [siteUrl]
              properties:
                siteUrl:
                  type: string
      responses:
        '200':
          description: List of owners
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DesignatedOwner'

  # ==================== Access Review - Notifications ====================
  /accessReview.listNotifications:
    post:
      tags: [Access Review]
      summary: List notifications
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                unreadOnly:
                  type: boolean
                  default: false
                campaignId:
                  type: string
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 50
      responses:
        '200':
          description: List of notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/AccessReviewNotification'
                  unreadCount:
                    type: integer
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /accessReview.createNotification:
    post:
      tags: [Access Review]
      summary: Create a notification
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [type, title, message]
              properties:
                type:
                  type: string
                  enum: [campaign_started, campaign_due_soon, campaign_overdue, review_assigned, execution_complete, schedule_triggered]
                title:
                  type: string
                message:
                  type: string
                campaignId:
                  type: string
                recipientEmail:
                  type: string
                  format: email
                sendEmail:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Created notification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewNotification'

  /accessReview.markNotificationRead:
    post:
      tags: [Access Review]
      summary: Mark notification as read
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Updated notification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessReviewNotification'

  /accessReview.markAllNotificationsRead:
    post:
      tags: [Access Review]
      summary: Mark all notifications as read
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /accessReview.deleteNotification:
    post:
      tags: [Access Review]
      summary: Delete a notification
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== Access Review - Reports ====================
  /accessReview.getCampaignReport:
    post:
      tags: [Access Review]
      summary: Get detailed campaign report
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Campaign report
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign:
                    type: object
                  summary:
                    type: object
                  breakdown:
                    type: object
                  items:
                    type: array

  /accessReview.sendCampaignReport:
    post:
      tags: [Access Review]
      summary: Send campaign report via email with PDF
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [campaignId, recipientEmails]
              properties:
                campaignId:
                  type: string
                recipientEmails:
                  type: array
                  items:
                    type: string
                    format: email
                includeDetails:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  recipientCount:
                    type: integer

  /accessReview.triggerScheduler:
    post:
      tags: [Access Review]
      summary: Manually trigger the scheduler
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [all, due_schedules, reminders, overdue]
                  default: all
      responses:
        '200':
          description: Scheduler triggered
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

tags:
  # Security Monitoring (parent category)
  - name: Security
    description: Security monitoring and threat detection
    kind: namespace
  - name: Alerts
    description: Security alert management
    parent: Security
  - name: Anomalies
    description: Anomaly detection and management
    parent: Security

  # Audit & Compliance (parent category)
  - name: Audit & Compliance
    description: Audit trails and compliance management
    kind: namespace
  - name: Audit Events
    description: SharePoint audit event tracking
    parent: Audit & Compliance
  - name: Compliance
    description: Compliance checks and reporting
    parent: Audit & Compliance
  - name: Reports
    description: Report generation and management
    parent: Audit & Compliance

  # Access Review (parent category)
  - name: Access Review
    description: |
      SharePoint access review and governance.

      Features:
      - Campaign management for periodic access reviews
      - Permission collection from SharePoint sites and drives
      - Decision workflow (retain/remove) with justifications
      - Automated execution of removal decisions
      - Scheduled reviews with reminders
      - Designated owner management
      - PDF report generation and email delivery
      - Notification system for review activities

  # Microsoft Integration (parent category)
  - name: Microsoft Integration
    description: Microsoft 365 and SharePoint integration
    kind: namespace
  - name: Microsoft
    description: Microsoft 365 connection management
    parent: Microsoft Integration
  - name: Sites
    description: SharePoint site management
    parent: Microsoft Integration

  # Application (parent category)
  - name: Application
    description: Application features
    kind: namespace
  - name: Dashboard
    description: Dashboard overview and statistics
    parent: Application
  - name: Settings
    description: User settings and credentials
    parent: Application
  - name: User
    description: User profile management
    parent: Application
