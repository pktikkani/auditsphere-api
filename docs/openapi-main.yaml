openapi: 3.0.3
info:
  title: AuditSphere API (Main Branch)
  description: |
    tRPC-based API for AuditSphere SPFX integration.
    All endpoints require Azure AD authentication via Bearer token.

    Base URL: `/api/trpc`

    tRPC endpoints follow the pattern: `POST /api/trpc/{router}.{procedure}`
  version: 1.0.0
  contact:
    name: AuditSphere Team

servers:
  - url: /api/trpc
    description: tRPC API endpoint

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Azure AD access token

  schemas:
    Pagination:
      type: object
      properties:
        page:
          type: integer
          minimum: 1
          default: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        total:
          type: integer
        totalPages:
          type: integer

    Alert:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [ANOMALY, COMPLIANCE, SECURITY]
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        status:
          type: string
          enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
        title:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time

    Anomaly:
      type: object
      properties:
        id:
          type: string
        anomalyType:
          type: string
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        status:
          type: string
          enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
        confidence:
          type: number
        anomalyScore:
          type: number
        createdAt:
          type: string
          format: date-time

    AuditEvent:
      type: object
      properties:
        id:
          type: string
        eventId:
          type: string
        operation:
          type: string
        userId:
          type: string
        siteUrl:
          type: string
        sourceFileName:
          type: string
        creationTime:
          type: string
          format: date-time
        clientIp:
          type: string

    ComplianceRun:
      type: object
      properties:
        id:
          type: string
        standardId:
          type: string
        status:
          type: string
          enum: [running, completed, failed]
        totalChecks:
          type: integer
        passedChecks:
          type: integer
        failedChecks:
          type: integer
        startedAt:
          type: string
          format: date-time

    Report:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [access_audit, compliance, anomaly, sharing, external_access]
        format:
          type: string
          enum: [pdf, xlsx, csv]
        status:
          type: string
          enum: [pending, generating, completed, error]
        createdAt:
          type: string
          format: date-time

    SharePointSite:
      type: object
      properties:
        id:
          type: string
        siteId:
          type: string
        siteUrl:
          type: string
        title:
          type: string
        isExternal:
          type: boolean

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        name:
          type: string
        role:
          type: string
        hasMicrosoftConnection:
          type: boolean

paths:
  # ==================== Alerts ====================
  /alerts.list:
    post:
      tags: [Alerts]
      summary: List alerts with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                type:
                  type: string
                  enum: [ANOMALY, COMPLIANCE, SECURITY]
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
                status:
                  type: string
                  enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Alert'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /alerts.getById:
    post:
      tags: [Alerts]
      summary: Get alert by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Alert details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'

  /alerts.updateStatus:
    post:
      tags: [Alerts]
      summary: Update alert status
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id, status]
              properties:
                id:
                  type: string
                status:
                  type: string
                  enum: [NEW, ACKNOWLEDGED, RESOLVED, DISMISSED]
      responses:
        '200':
          description: Updated alert
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'

  /alerts.stats:
    post:
      tags: [Alerts]
      summary: Get alert statistics
      responses:
        '200':
          description: Alert statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  recentAlerts:
                    type: integer
                  unreadCount:
                    type: integer
                  bySeverity:
                    type: object
                  byStatus:
                    type: object
                  byType:
                    type: object

  /alerts.markAllRead:
    post:
      tags: [Alerts]
      summary: Mark all alerts as read
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== Anomalies ====================
  /anomalies.list:
    post:
      tags: [Anomalies]
      summary: List anomalies with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
                status:
                  type: string
                  enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
                anomalyType:
                  type: string
                userId:
                  type: string
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of anomalies
          content:
            application/json:
              schema:
                type: object
                properties:
                  anomalies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Anomaly'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /anomalies.getById:
    post:
      tags: [Anomalies]
      summary: Get anomaly by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Anomaly details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Anomaly'

  /anomalies.updateStatus:
    post:
      tags: [Anomalies]
      summary: Update anomaly status
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id, status]
              properties:
                id:
                  type: string
                status:
                  type: string
                  enum: [NEW, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
                resolution:
                  type: string
                  maxLength: 1000
      responses:
        '200':
          description: Updated anomaly
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Anomaly'

  /anomalies.stats:
    post:
      tags: [Anomalies]
      summary: Get anomaly statistics
      responses:
        '200':
          description: Anomaly statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  recentAnomalies:
                    type: integer
                  unresolvedCount:
                    type: integer
                  bySeverity:
                    type: object
                  byStatus:
                    type: object
                  byType:
                    type: array

  # ==================== Audit Events ====================
  /auditEvents.list:
    post:
      tags: [Audit Events]
      summary: List audit events with filters
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                operation:
                  type: string
                userId:
                  type: string
                siteUrl:
                  type: string
                userType:
                  type: integer
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                sortOrder:
                  type: string
                  enum: [asc, desc]
                  default: desc
      responses:
        '200':
          description: List of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  total:
                    type: integer
                  anomalyCount:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /auditEvents.getById:
    post:
      tags: [Audit Events]
      summary: Get audit event by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Audit event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEvent'

  /auditEvents.stats:
    post:
      tags: [Audit Events]
      summary: Get audit event statistics
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 90
                  default: 7
      responses:
        '200':
          description: Audit event statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                  operations:
                    type: array
                  userTypes:
                    type: array
                  dailyTrend:
                    type: array
                  users:
                    type: array

  /auditEvents.getUsers:
    post:
      tags: [Audit Events]
      summary: Get unique users list
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 90
                  default: 30
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    userId:
                      type: string
                    eventCount:
                      type: integer

  # ==================== Compliance ====================
  /compliance.run:
    post:
      tags: [Compliance]
      summary: Run compliance checks
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                standardId:
                  type: string
                  enum: [CIS-MS365, CUSTOM, ALL]
                siteUrls:
                  type: array
                  items:
                    type: string
                    format: uri
      responses:
        '200':
          description: Compliance run started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  runId:
                    type: string
                  message:
                    type: string

  /compliance.summary:
    post:
      tags: [Compliance]
      summary: Get compliance summary
      responses:
        '200':
          description: Compliance summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  passed:
                    type: integer
                  failed:
                    type: integer
                  passRate:
                    type: integer
                  lastRunAt:
                    type: string
                    format: date-time

  /compliance.runs:
    post:
      tags: [Compliance]
      summary: List compliance runs
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 10
      responses:
        '200':
          description: List of compliance runs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ComplianceRun'

  /compliance.runById:
    post:
      tags: [Compliance]
      summary: Get compliance run details
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Compliance run details
          content:
            application/json:
              schema:
                type: object
                properties:
                  run:
                    $ref: '#/components/schemas/ComplianceRun'
                  checks:
                    type: array

  /compliance.checkDefinitions:
    post:
      tags: [Compliance]
      summary: Get compliance check definitions
      responses:
        '200':
          description: Check definitions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    code:
                      type: string
                    name:
                      type: string
                    description:
                      type: string
                    category:
                      type: string
                    severity:
                      type: string
                    standardId:
                      type: string

  /compliance.latestChecks:
    post:
      tags: [Compliance]
      summary: Get latest compliance check results
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 50
                status:
                  type: string
                  enum: [PASS, FAIL, WARNING, ERROR, SKIPPED]
                category:
                  type: string
                severity:
                  type: string
                  enum: [LOW, MEDIUM, HIGH, CRITICAL]
      responses:
        '200':
          description: Latest check results
          content:
            application/json:
              schema:
                type: object
                properties:
                  checks:
                    type: array
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /compliance.clear:
    post:
      tags: [Compliance]
      summary: Clear compliance results
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ==================== Dashboard ====================
  /dashboard.overview:
    post:
      tags: [Dashboard]
      summary: Get dashboard overview data
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  minimum: 1
                  maximum: 30
                  default: 7
      responses:
        '200':
          description: Dashboard overview
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: object
                  anomalies:
                    type: object
                  alerts:
                    type: object
                  compliance:
                    type: object
                  trends:
                    type: object
                  period:
                    type: object

  /dashboard.quickStats:
    post:
      tags: [Dashboard]
      summary: Get quick stats for header/nav
      responses:
        '200':
          description: Quick stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  unresolvedAnomalies:
                    type: integer
                  unreadAlerts:
                    type: integer

  /dashboard.activityFeed:
    post:
      tags: [Dashboard]
      summary: Get activity feed
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  minimum: 1
                  maximum: 50
                  default: 20
      responses:
        '200':
          description: Activity feed
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [event, anomaly]
                    id:
                      type: string
                    timestamp:
                      type: string
                      format: date-time
                    title:
                      type: string
                    subtitle:
                      type: string
                    details:
                      type: string

  # ==================== Microsoft ====================
  /microsoft.status:
    post:
      tags: [Microsoft]
      summary: Get Microsoft connection status
      responses:
        '200':
          description: Connection status
          content:
            application/json:
              schema:
                type: object
                properties:
                  connected:
                    type: boolean
                  connections:
                    type: array

  /microsoft.sites:
    post:
      tags: [Microsoft]
      summary: Get SharePoint sites
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    graphId:
                      type: string
                    displayName:
                      type: string
                    webUrl:
                      type: string

  /microsoft.disconnect:
    post:
      tags: [Microsoft]
      summary: Disconnect Microsoft account
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [connectionId]
              properties:
                connectionId:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /microsoft.health:
    post:
      tags: [Microsoft]
      summary: Get connection health
      responses:
        '200':
          description: Connection health
          content:
            application/json:
              schema:
                type: object
                properties:
                  healthy:
                    type: boolean
                  message:
                    type: string
                  lastSync:
                    type: string
                    format: date-time
                  tenantName:
                    type: string

  # ==================== Reports ====================
  /reports.list:
    post:
      tags: [Reports]
      summary: List reports
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                type:
                  type: string
                  enum: [access_audit, compliance, anomaly, sharing, external_access]
                status:
                  type: string
                  enum: [PENDING, GENERATING, COMPLETED, FAILED]
      responses:
        '200':
          description: List of reports
          content:
            application/json:
              schema:
                type: object
                properties:
                  reports:
                    type: array
                    items:
                      $ref: '#/components/schemas/Report'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /reports.getById:
    post:
      tags: [Reports]
      summary: Get report by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Report details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /reports.generate:
    post:
      tags: [Reports]
      summary: Generate a new report
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, type]
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                type:
                  type: string
                  enum: [access_audit, compliance, anomaly, sharing, external_access]
                format:
                  type: string
                  enum: [pdf, xlsx, csv]
                  default: csv
                parameters:
                  type: object
      responses:
        '200':
          description: Generated report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /reports.delete:
    post:
      tags: [Reports]
      summary: Delete a report
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /reports.types:
    post:
      tags: [Reports]
      summary: Get report types
      responses:
        '200':
          description: Report types
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    description:
                      type: string

  # ==================== Sites ====================
  /sites.list:
    post:
      tags: [Sites]
      summary: List SharePoint sites
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                page:
                  type: integer
                  default: 1
                limit:
                  type: integer
                  default: 20
                search:
                  type: string
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: object
                properties:
                  sites:
                    type: array
                    items:
                      $ref: '#/components/schemas/SharePointSite'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer

  /sites.getById:
    post:
      tags: [Sites]
      summary: Get site by ID
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SharePointSite'

  /sites.stats:
    post:
      tags: [Sites]
      summary: Get site statistics
      responses:
        '200':
          description: Site statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  externalCount:
                    type: integer
                  recentlyActive:
                    type: integer

  # ==================== Settings ====================
  /settings.getCredentials:
    post:
      tags: [Settings]
      summary: Get credentials status (masked)
      responses:
        '200':
          description: Credentials status
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasCustomCredentials:
                    type: boolean
                  useCustomCredentials:
                    type: boolean
                  envConfigured:
                    type: boolean
                  credentials:
                    type: object

  /settings.saveCredentials:
    post:
      tags: [Settings]
      summary: Save or update credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [tenantId, clientId, clientSecret]
              properties:
                tenantId:
                  type: string
                clientId:
                  type: string
                clientSecret:
                  type: string
                useCustomCredentials:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /settings.deleteCredentials:
    post:
      tags: [Settings]
      summary: Delete custom credentials
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /settings.toggleCustomCredentials:
    post:
      tags: [Settings]
      summary: Toggle use of custom credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [useCustomCredentials]
              properties:
                useCustomCredentials:
                  type: boolean
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  useCustomCredentials:
                    type: boolean

  # ==================== User ====================
  /user.me:
    post:
      tags: [User]
      summary: Get current user info
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

tags:
  - name: Alerts
    description: Security alert management
  - name: Anomalies
    description: Anomaly detection and management
  - name: Audit Events
    description: SharePoint audit event tracking
  - name: Compliance
    description: Compliance checks and reporting
  - name: Dashboard
    description: Dashboard overview and statistics
  - name: Microsoft
    description: Microsoft 365 connection management
  - name: Reports
    description: Report generation and management
  - name: Sites
    description: SharePoint site management
  - name: Settings
    description: User settings and credentials
  - name: User
    description: User profile management
